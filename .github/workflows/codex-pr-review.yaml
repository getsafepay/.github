name: Codex PR review

on:
  workflow_call:
    secrets:
      OPENAI_API_KEY:
        required: true

jobs:
  codex_pr_review:
    # This is the main job Codex runs in.
    runs-on: ubuntu-latest

    permissions:
      contents: read # Needed to checkout code
      pull-requests: write # Needed to update PR body
      issues: write # Needed to post PR comments

    outputs:
      review_message: ${{ steps.codex_review.outputs.final-message }}
      summary_message: ${{ steps.codex_summary.outputs.final-message }}

    steps:
      - name: Checkout PR merge commit
        uses: actions/checkout@v5
        with:
          # Check out the PR's merge commit so Codex sees the combined changes.
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      - name: Pre-fetch base and head refs
        run: |
          git fetch --no-tags origin \
            ${{ github.event.pull_request.base.ref }} \
            +refs/pull/${{ github.event.pull_request.number }}/head

      # 1) Checkout the shared `.github` repo into a subdirectory
      - name: Checkout shared workflows & prompts
        uses: actions/checkout@v5
        with:
          repository: getsafepay/.github
          path: .github
      #
      # 2) Run Codex to REVIEW the PR
      #
      - name: Codex PR review
        id: codex_review
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: .github/prompts/pr-review.md

  #
  # Post feedback job: post review comment + update PR body
  #
  post_feedback:
    runs-on: ubuntu-latest
    needs: codex_pr_review

    permissions:
      pull-requests: write
      issues: write

    steps:
      - name: Post Codex review as PR comment
        if: needs.codex_pr_review.outputs.review_message != ''
        uses: actions/github-script@v7
        env:
          CODEX_REVIEW: ${{ needs.codex_pr_review.outputs.review_message }}
        with:
          github-token: ${{ github.token }}
          script: |
            const body = process.env.CODEX_REVIEW;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body,
            });
